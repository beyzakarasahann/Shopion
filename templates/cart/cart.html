{% extends 'base.html' %}

{% block content %}
  <!-- üõí CART CONTENT -->
  <div class="max-w-screen-xl mx-auto px-4 py-10 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- üßæ √úr√ºnler (Sol) -->
    <div class="md:col-span-2 space-y-6" id="cart-items">
      <!-- Sepet √∂ƒüeleri burada g√∂r√ºnecek -->
      {% for item in cart_items %}
        <div class="flex justify-between p-4 bg-gray-100 dark:bg-gray-800 rounded-lg shadow">
          <div>
            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-20 h-20 object-contain rounded">
            <div>
              <h3 class="font-semibold">{{ item.product.name }}</h3>
              <p>‚Ç∫{{ item.get_total_price }}</p>
            </div>
          </div>
          <div>
            <a href="{% url 'cart:remove_from_cart' product_id=item.product.id %}" class="text-red-500">Remove</a>
          </div>
        </div>
      {% empty %}
        <p>Your cart is empty.</p>
      {% endfor %}
    </div>

    <!-- üí≥ Sipari≈ü √ñzeti (Saƒü) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 h-fit">
      <h2 class="text-xl font-bold mb-4">Sipari≈ü √ñzeti</h2>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span>√úr√ºnlerin Toplamƒ±</span>
          <span>‚Ç∫{{ total_price }}</span>
        </div>
        <div class="flex justify-between">
          <span>Kargo</span>
          <span>‚Ç∫44.99</span>
        </div>
        <div class="flex justify-between text-green-600 font-medium">
          <span>Kargo Bedava ƒ∞ndirimi</span>
          <span>-‚Ç∫44.99</span>
        </div>
        <hr class="my-2 border-gray-300 dark:border-gray-600">
        <div class="flex justify-between font-bold text-lg">
          <span>Toplam</span>
          <span>‚Ç∫{{ total_price }}</span>
        </div>
      </div>

      <div class="mt-6 space-y-3">
        <button onclick="clearCart()" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600">Sepeti Temizle</button>
        <a href="/products" class="w-full inline-block text-center bg-secondary text-white py-2 rounded hover:bg-indigo-600">Alƒ±≈üveri≈üe Devam Et</a>
        <button onclick="handleCheckout()" class="w-full inline-block text-center bg-primary text-white py-2 rounded hover:bg-[#a855f7]">
          Sepeti Onayla
        </button>
      </div>
    </div>
  </div>
{% endblock %}

<script>
  // Sepet sayƒ±sƒ±nƒ± g√ºncelleme
  function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const totalCount = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
    const counter = document.getElementById("cart-count");
    if (counter) counter.textContent = totalCount;  // Sepetteki √∂ƒüe sayƒ±sƒ±nƒ± g√∂ster
  }

  // Sayfa y√ºklendiƒüinde sepet sayƒ±sƒ±nƒ± g√ºncelle
  window.onload = function() {
    updateCartCount();
  };

  // Sepeti g√∂rsel olarak render et
  function renderCart() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const container = document.getElementById("cart-items");
    const totalDisplay = document.getElementById("cart-total");
    container.innerHTML = "";
    let total = 0;

    cart.forEach((item, index) => {
      const price = parseFloat(item.price);
      const quantity = item.quantity || 1;
      const totalPrice = price * quantity;

      const div = document.createElement("div");
      div.className = "flex items-center justify-between p-4 bg-gray-100 dark:bg-gray-800 rounded-lg shadow";

      div.innerHTML = `
        <div class="flex items-center gap-4">
          <input type="checkbox" class="item-checkbox w-5 h-5 accent-primary" checked>
          <img src="${item.img}" class="w-20 h-20 object-contain rounded bg-white" alt="${item.name}">
          <div>
            <h3 class="font-semibold">${item.name}</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 price">‚Ç∫${totalPrice.toFixed(2)}</p>
            <div class="flex items-center gap-2 mt-2">
              <button onclick="changeQuantity(${index}, -1)"
                      class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center hover:bg-[#a855f7] transition">
                <i class="fas fa-minus"></i>
              </button>
              <span class="w-8 text-center font-medium text-lg">${quantity}</span>
              <button onclick="changeQuantity(${index}, 1)"
                      class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center hover:bg-[#a855f7] transition">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
        </div>
        <button onclick="removeItem(${index})" class="text-red-500 hover:text-red-700">Remove</button>
      `;
      container.appendChild(div);

      total += totalPrice;
    });

    updateSelectedTotal();
  }

  // Se√ßilen toplamƒ± g√ºncelle
  function updateSelectedTotal() {
    const checkboxes = document.querySelectorAll(".item-checkbox");
    const prices = document.querySelectorAll(".price");
    let subtotal = 0;

    checkboxes.forEach((box, idx) => {
      if (box.checked) {
        const price = parseFloat(prices[idx].textContent.replace("‚Ç∫", ""));
        subtotal += price;
      }
    });

    const shipping = subtotal > 0 ? 44.99 : 0;
    const shippingDiscount = subtotal > 0 ? 44.99 : 0;
    const total = subtotal + shipping - shippingDiscount;

    document.getElementById("cart-total").textContent = `‚Ç∫${total.toFixed(2)}`;
    document.getElementById("summary-subtotal").textContent = `‚Ç∫${subtotal.toFixed(2)}`;
    document.getElementById("summary-total").textContent = `‚Ç∫${total.toFixed(2)}`;

    const discountRow = document.querySelector(".text-green-600");
    if (discountRow) {
      discountRow.style.display = subtotal > 0 ? "flex" : "none";
    }
  }

  // Sepetten √ºr√ºn √ßƒ±karma
  function removeItem(index) {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    cart.splice(index, 1);
    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
    updateCartCount();
    showToast("√úr√ºn sepetten kaldƒ±rƒ±ldƒ±"); // ‚úÖ Burasƒ±
  }

  // Sepet sayƒ±sƒ±nƒ± g√ºncelle
  function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const totalCount = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
    const counter = document.getElementById("cart-count");
    if (counter) counter.textContent = totalCount;
  }

  // Sepet g√ºncelleme
  function changeQuantity(index, change) {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    cart[index].quantity = (cart[index].quantity || 1) + change;

    // Eƒüer miktar 1'in altƒ±na d√º≈üerse √ºr√ºn√º kaldƒ±r
    if (cart[index].quantity <= 0) {
      cart.splice(index, 1);
    }

    localStorage.setItem("cart", JSON.stringify(cart));
    renderCart();
    updateCartCount();
    showToast("Sepet ba≈üarƒ±yla g√ºncellendi"); // ‚úÖ Burayƒ± ekle
  }

  function showToast(message) {
    const toast = document.getElementById("toast-success");
    const text = document.getElementById("toast-message");
    text.textContent = message;
    toast.classList.remove("hidden");

    setTimeout(() => {
      toast.classList.add("hidden");
    }, 2000);
  }

  renderCart();
  updateCartCount();
</script>

<!-- üõë Checkout Modal -->
<div id="checkoutModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-sm w-full shadow-lg text-center">
    <div class="text-4xl text-orange-500 mb-2">‚ö†Ô∏è</div>
    <h2 class="text-xl font-semibold mb-2 text-gray-800 dark:text-white">TrendVerse Hesabƒ±nƒ±z Yok Mu?</h2>
    <div class="text-sm text-gray-600 dark:text-gray-300 mb-4">Sipari≈ü vermek i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z.</div>
    <div class="flex justify-center gap-4">
      <a href="login.html" class="px-4 py-2 bg-primary text-white rounded hover:bg-[#a855f7] transition">Giri≈ü Yap</a>
      <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition">Kapat</button>
    </div>
  </div>
</div>

<!-- ‚úÖ Toast Bildirim Kutusu -->
<div id="toast-success" class="fixed top-6 right-6 bg-green-500 text-white px-6 py-3 rounded shadow-lg flex items-center space-x-2 z-[9999] hidden">
  <i class="fas fa-check text-xl"></i>
  <span id="toast-message">Sepet ba≈üarƒ±yla g√ºncellendi</span>
</div>
